x-default-env: &default-env
  env_file:
    - .env

services:
  postgres:
    image: postgres:16-alpine
    <<: *default-env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?}
      POSTGRES_DB: ${POSTGRES_DB:?}
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    secrets:
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - reauth-net

  redis:
    image: redis:7-alpine
    entrypoint:
      - /bin/sh
      - -c
      - |
        REDIS_PASSWORD="$$(cat /run/secrets/redis_password)"
        exec redis-server --save "" --appendonly no --requirepass "$$REDIS_PASSWORD" --protected-mode yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    secrets:
      - redis_password
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - reauth-net

  api:
    image: reauth-api:latest
    <<: *default-env
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      PORT: ${API_PORT:-3001}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${POSTGRES_DB:?}
      DB_USER: ${POSTGRES_USER:?}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      APP_ORIGIN: ${APP_ORIGIN:?}
      BIND_ADDR: 0.0.0.0:${API_PORT:-3001}
      RATE_LIMIT_WINDOW_SECS: ${RATE_LIMIT_WINDOW_SECS:-60}
      RATE_LIMIT_PER_IP: ${RATE_LIMIT_PER_IP:-60}
      RATE_LIMIT_PER_EMAIL: ${RATE_LIMIT_PER_EMAIL:-30}
    ports:
      - "127.0.0.1:${API_PORT:-3001}:${API_PORT:-3001}"
    depends_on:
      - postgres
      - redis
    secrets:
      - jwt_secret
      - fallback_resend_api_key
      - postgres_password
      - redis_password
      - process_number_key
      - fallback_google_client_id
      - fallback_google_client_secret
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Read passwords and URL-encode special characters for Postgres
        POSTGRES_PASSWORD_RAW="$$(cat /run/secrets/postgres_password)"
        POSTGRES_PASSWORD_ENC="$$(echo -n "$$POSTGRES_PASSWORD_RAW" | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')"
        export DATABASE_URL="postgres://${DB_USER}:$$POSTGRES_PASSWORD_ENC@${DB_HOST}:${DB_PORT}/${DB_NAME}"

        # Redis password should NOT be URL-encoded - Redis client handles it differently
        REDIS_PASSWORD_RAW="$$(cat /run/secrets/redis_password)"
        export REDIS_URL="redis://default:$$REDIS_PASSWORD_RAW@${REDIS_HOST}:${REDIS_PORT}"

        export JWT_SECRET="$$(cat /run/secrets/jwt_secret)"
        export FALLBACK_RESEND_API_KEY="$$(cat /run/secrets/fallback_resend_api_key)"
        export FALLBACK_EMAIL_DOMAIN="${FALLBACK_EMAIL_DOMAIN:-mail.reauth.dev}"
        export PROCESS_NUMBER_KEY="$$(cat /run/secrets/process_number_key)"
        export FALLBACK_GOOGLE_CLIENT_ID="$$(cat /run/secrets/fallback_google_client_id)"
        export FALLBACK_GOOGLE_CLIENT_SECRET="$$(cat /run/secrets/fallback_google_client_secret)"
        exec reauth-api
    restart: unless-stopped
    networks:
      - reauth-net

  migrate:
    image: reauth-api:latest
    <<: *default-env
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${POSTGRES_DB:?}
      DB_USER: ${POSTGRES_USER:?}
    depends_on:
      postgres:
        condition: service_healthy
    secrets:
      - postgres_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        POSTGRES_PASSWORD_RAW="$$(cat /run/secrets/postgres_password)"
        POSTGRES_PASSWORD_ENC="$$(echo -n "$$POSTGRES_PASSWORD_RAW" | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')"
        export DATABASE_URL="postgres://${DB_USER}:$$POSTGRES_PASSWORD_ENC@${DB_HOST}:${DB_PORT}/${DB_NAME}"
        exec sqlx migrate run
    restart: "no"
    networks:
      - reauth-net

  ui:
    image: reauth-ui:latest
    <<: *default-env
    environment:
      NODE_ENV: production
      PORT: ${UI_PORT:-3000}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:?}
      # Internal API URL for server-side requests (SSR)
      API_BASE: http://api:${API_PORT:-3001}
    ports:
      - "127.0.0.1:${UI_PORT:-3000}:${UI_PORT:-3000}"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - reauth-net

  demo-api:
    image: demo-api:latest
    <<: *default-env
    environment:
      NODE_ENV: production
      PORT: ${DEMO_API_PORT:-3003}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      DOMAIN: ${DEMO_DOMAIN:-anypost.xyz}
    ports:
      - "127.0.0.1:${DEMO_API_PORT:-3003}:${DEMO_API_PORT:-3003}"
    depends_on:
      - redis
    secrets:
      - redis_password
      - anypost_api_key
    entrypoint:
      - /bin/sh
      - -c
      - |
        REDIS_PASSWORD_RAW="$$(cat /run/secrets/redis_password)"
        export REDIS_URL="redis://default:$$REDIS_PASSWORD_RAW@${REDIS_HOST:-redis}:${REDIS_PORT:-6379}"
        export REAUTH_API_KEY="$$(cat /run/secrets/anypost_api_key)"
        exec node dist/index.js
    restart: unless-stopped
    networks:
      - reauth-net

  demo-ui:
    image: demo-ui:latest
    <<: *default-env
    environment:
      NODE_ENV: production
      PORT: ${DEMO_UI_PORT:-3002}
      NEXT_PUBLIC_DOMAIN: ${DEMO_DOMAIN:-anypost.xyz}
    ports:
      - "127.0.0.1:${DEMO_UI_PORT:-3002}:${DEMO_UI_PORT:-3002}"
    depends_on:
      - demo-api
    restart: unless-stopped
    networks:
      - reauth-net

  caddy:
    image: caddy:2-alpine
    network_mode: host
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/ingress:/srv/ingress:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - ui
      - api
      - demo-ui
      - demo-api
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  caddy-data:
  caddy-config:

secrets:
  jwt_secret:
    file: ./secrets/jwt_secret
  postgres_password:
    file: ./secrets/postgres_password
  redis_password:
    file: ./secrets/redis_password
  process_number_key:
    file: ./secrets/process_number_key
  # Fallback Resend API key for domains without custom email config
  fallback_resend_api_key:
    file: ./secrets/fallback_resend_api_key
  # Fallback Google OAuth credentials for domains without custom OAuth config
  fallback_google_client_id:
    file: ./secrets/fallback_google_client_id
  fallback_google_client_secret:
    file: ./secrets/fallback_google_client_secret
  # Developer API keys for server-to-server authentication
  reauth_dev_api_key:
    file: ./secrets/reauth_dev_api_key
  anypost_api_key:
    file: ./secrets/anypost_api_key
  # NOTE: No Stripe secrets here - each domain must configure their own Stripe account.
  # We cannot accept payments on behalf of other developers.

networks:
  reauth-net:
    driver: bridge
