{
    email contact@tqdm.org

    on_demand_tls {
        ask http://127.0.0.1:3001/api/domains/check-allowed
    }
}

# Main app - reauth.dev and www.reauth.dev
reauth.dev, www.reauth.dev {
    # API routes
    handle /api/* {
        reverse_proxy 127.0.0.1:3001
    }

    # Everything else goes to UI
    reverse_proxy 127.0.0.1:3000
}

# Demo todo app - anypost.xyz
anypost.xyz, www.anypost.xyz {
    # Demo API routes
    handle /api/* {
        reverse_proxy 127.0.0.1:3003
    }

    # Demo UI
    reverse_proxy 127.0.0.1:3002
}

# Catch-all for custom domains including reauth.reauth.dev (on-demand TLS)
# This handles any domain that CNAMEs to ingress.reauth.dev
:443 {
    tls {
        on_demand
    }

    # API routes for custom domains (session checks, auth)
    handle /api/* {
        reverse_proxy 127.0.0.1:3001
    }

    # All other routes go to Next.js UI
    reverse_proxy 127.0.0.1:3000
}
