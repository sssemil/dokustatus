#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")"

# Load environment from apps/api/.env if it exists
if [[ -f apps/api/.env ]]; then
    set -a
    source apps/api/.env
    set +a
fi

# Default environment variables for local development
export DATABASE_URL="${DATABASE_URL:-postgres://user:password@localhost:5432/reauth}"
export REDIS_URL="${REDIS_URL:-redis://localhost:6379}"

# ============================================================================
# Infrastructure commands
# ============================================================================

cmd_infra() {
    echo "Starting postgres and redis..."
    docker compose up -d postgres redis
    docker compose ps
}

cmd_infra_full() {
    # Check if certs exist
    if [[ ! -f local_infra/certs/localhost.pem ]]; then
        echo "Error: TLS certificates not found. Run './run certs' first."
        exit 1
    fi
    echo "Starting postgres, redis, coredns, and caddy..."
    docker compose up -d postgres redis coredns caddy
    docker compose ps
}

cmd_infra_stop() {
    echo "Stopping containers..."
    docker compose down
}

cmd_infra_logs() {
    docker compose logs -f "$@"
}

# ============================================================================
# Database commands
# ============================================================================

cmd_db_migrate() {
    echo "Running migrations..."
    cd apps/api
    cargo sqlx migrate run
}

cmd_db_prepare() {
    echo "Preparing SQLx offline data..."
    cd apps/api
    cargo sqlx prepare -- --bin reauth-api
}

cmd_dev_seed() {
    echo "Replacing reauth.dev with reauth.test for local development..."
    psql "$DATABASE_URL" <<'EOF'
-- Rename reauth.dev to reauth.test (keeps owner, config, everything)
UPDATE domains SET domain = 'reauth.test' WHERE domain = 'reauth.dev';
EOF
    echo "Done! reauth.dev is now reauth.test"
    echo ""
    echo "Ensure /etc/hosts has:"
    echo "  127.0.0.1 reauth.test reauth.reauth.test ingress.reauth.test"
}

# ============================================================================
# API commands (Rust backend)
# ============================================================================

cmd_api() {
    echo "Starting API..."
    cd apps/api
    cargo run "$@"
}

cmd_api_fmt() {
    echo "Formatting Rust code..."
    cd apps/api
    cargo fmt "$@"
}

cmd_api_lint() {
    echo "Running clippy..."
    cd apps/api
    cargo clippy --all-targets --all-features "$@"
}

cmd_api_test() {
    echo "Running API tests..."
    cd apps/api
    cargo test "$@"
}

cmd_api_build() {
    echo "Building API for production (offline mode)..."
    cd apps/api
    SQLX_OFFLINE=true cargo build --release "$@"
}

# ============================================================================
# UI commands (Next.js frontend)
# ============================================================================

cmd_ui() {
    echo "Starting UI dev server..."
    cd apps/ui
    npm run dev
}

cmd_ui_install() {
    echo "Installing UI dependencies..."
    cd apps/ui
    npm install "$@"
}

cmd_ui_build() {
    echo "Building UI for production..."
    cd apps/ui
    npm run build
}

# ============================================================================
# SDK commands (TypeScript SDK)
# ============================================================================

cmd_sdk() {
    echo "Starting SDK in watch mode..."
    cd libs/reauth-sdk-ts
    npm run dev
}

cmd_sdk_build() {
    echo "Building SDK..."
    cd libs/reauth-sdk-ts
    npm run build
}

# ============================================================================
# Demo app commands
# ============================================================================

cmd_demo() {
    echo "Starting demo UI and API..."
    echo "Demo UI: http://localhost:3002 (or https://demo.test via Caddy)"
    echo "Demo API: http://localhost:3003"
    echo ""

    # Run both in parallel
    (cd apps/demo_api && npm run dev) &
    (cd apps/demo_ui && npm run dev) &
    wait
}

cmd_demo_api() {
    echo "Starting demo API..."
    cd apps/demo_api
    npm run dev
}

cmd_demo_ui() {
    echo "Starting demo UI..."
    cd apps/demo_ui
    npm run dev
}

cmd_demo_install() {
    echo "Installing demo dependencies..."

    # Build SDK first
    echo "Building SDK..."
    (cd libs/reauth-sdk-ts && npm install && npm run build)

    echo "Installing demo API dependencies..."
    (cd apps/demo_api && npm install)

    echo "Installing demo UI dependencies..."
    (cd apps/demo_ui && npm install)

    echo "Done!"
}

cmd_demo_setup() {
    echo "Setting up demo.test domain..."

    # Get owner ID from reauth.test domain
    local owner_id
    owner_id=$(psql "$DATABASE_URL" -t -c "SELECT owner_id FROM domains WHERE domain = 'reauth.test'" | tr -d ' ')

    if [[ -z "$owner_id" ]]; then
        echo "Error: reauth.test not found. Run './run dev:seed' first."
        exit 1
    fi

    psql "$DATABASE_URL" <<EOF
-- Create demo.test domain with same owner as reauth.test
INSERT INTO domains (domain, owner_id)
VALUES ('demo.test', '$owner_id')
ON CONFLICT (domain) DO NOTHING;
EOF

    echo "Done! demo.test domain created."
    echo ""
    echo "Ensure /etc/hosts has:"
    echo "  127.0.0.1 demo.test reauth.demo.test"
}

# ============================================================================
# Docker commands
# ============================================================================

cmd_build() {
    echo "Building Docker images..."
    ./build-images.sh "$@"
}

# ============================================================================
# Local TLS/DNS commands
# ============================================================================

cmd_certs() {
    echo "Generating local TLS certificates with mkcert..."
    ./local_infra/setup-certs.sh
}

cmd_dns_add() {
    local domain="$1"
    local domain_id="$2"

    if [[ -z "$domain" || -z "$domain_id" ]]; then
        echo "Usage: ./run dns:add <domain> <domain_id>"
        echo "Example: ./run dns:add example.test abc123-uuid"
        exit 1
    fi

    local zone_file="local_infra/coredns/db.test"

    # Append CNAME and TXT records
    echo "" >> "$zone_file"
    echo "; Domain: $domain (added $(date +%Y-%m-%d))" >> "$zone_file"
    echo "reauth.$domain    IN CNAME ingress.local.test." >> "$zone_file"
    echo "_reauth.$domain   IN TXT   \"project=$domain_id\"" >> "$zone_file"

    echo "Added DNS records for $domain:"
    echo "  CNAME: reauth.$domain -> ingress.local.test"
    echo "  TXT:   _reauth.$domain -> project=$domain_id"

    # Reload CoreDNS if running
    if docker ps --format '{{.Names}}' | grep -q reauth-coredns; then
        echo "Reloading CoreDNS..."
        docker exec reauth-coredns kill -SIGUSR1 1 2>/dev/null || true
    fi

    echo ""
    echo "Don't forget to add to /etc/hosts:"
    echo "  echo \"127.0.0.1 reauth.$domain\" | sudo tee -a /etc/hosts"
}

# ============================================================================
# Help
# ============================================================================

cmd_help() {
    cat <<EOF
Usage: ./run <command>

Infrastructure:
  infra          Start postgres and redis (basic dev)
  infra:full     Start postgres, redis, coredns, and caddy (TLS dev)
  infra:stop     Stop all containers
  infra:logs     Tail container logs (pass service names to filter)

Database:
  db:migrate     Run SQLx migrations
  db:prepare     Refresh SQLx offline data for CI/Docker builds
  dev:seed       Rename reauth.dev to reauth.test for local dev

API (Rust backend):
  api            Run the API locally
  api:fmt        Format Rust code
  api:lint       Run clippy lints
  api:test       Run backend tests
  api:build      Production build with SQLX_OFFLINE=true

UI (Next.js frontend):
  ui             Run the UI dev server
  ui:install     Install npm dependencies
  ui:build       Production build

SDK (TypeScript):
  sdk            Run SDK in watch/dev mode
  sdk:build      Build the TypeScript SDK

Demo app:
  demo           Start both demo UI and API
  demo:api       Start demo API only
  demo:ui        Start demo UI only
  demo:install   Install demo dependencies (builds SDK first)
  demo:setup     Create demo.test domain in database

Docker:
  build          Build Docker images via build-images.sh

Local TLS/DNS:
  certs          Generate local TLS certificates with mkcert
  dns:add        Add CNAME/TXT records for a domain (dns:add <domain> <uuid>)

Other:
  help           Show this help message

Examples:
  ./run infra                           # Start all local services
  ./run db:migrate                      # Apply database migrations
  ./run api                             # Start the API
  ./run ui                              # Start the UI dev server
  ./run certs                           # Generate mkcert certificates (one-time)
  ./run dns:add example.test abc-uuid   # Add DNS records for a test domain
EOF
}

# ============================================================================
# Main router
# ============================================================================

case "${1:-help}" in
    infra)        cmd_infra ;;
    infra:full)   cmd_infra_full ;;
    infra:stop)   cmd_infra_stop ;;
    infra:logs)   shift; cmd_infra_logs "$@" ;;
    db:migrate)   cmd_db_migrate ;;
    db:prepare)   cmd_db_prepare ;;
    dev:seed)     cmd_dev_seed ;;
    api)          shift; cmd_api "$@" ;;
    api:fmt)      shift; cmd_api_fmt "$@" ;;
    api:lint)     shift; cmd_api_lint "$@" ;;
    api:test)     shift; cmd_api_test "$@" ;;
    api:build)    shift; cmd_api_build "$@" ;;
    ui)           cmd_ui ;;
    ui:install)   shift; cmd_ui_install "$@" ;;
    ui:build)     cmd_ui_build ;;
    sdk)          cmd_sdk ;;
    sdk:build)    cmd_sdk_build ;;
    demo)         cmd_demo ;;
    demo:api)     cmd_demo_api ;;
    demo:ui)      cmd_demo_ui ;;
    demo:install) cmd_demo_install ;;
    demo:setup)   cmd_demo_setup ;;
    build)        shift; cmd_build "$@" ;;
    certs)        cmd_certs ;;
    dns:add)      shift; cmd_dns_add "$@" ;;
    help)         cmd_help ;;
    *)            echo "Unknown command: $1"; echo; cmd_help; exit 1 ;;
esac
